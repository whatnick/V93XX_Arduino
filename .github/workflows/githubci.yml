name: Arduino Library CI

on: [pull_request, push, repository_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install clang-format
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format

    - name: Check code formatting with clang-format
      run: |
        find . -type f \( -name "*.h" -o -name "*.cpp" -o -name "*.ino" \) \
          -not -path "./build/*" \
          -not -path "./.venv/*" \
          -not -path "./ci/*" \
          -not -path "./bin/*" \
          -print0 | xargs -0 clang-format --dry-run --Werror

    - name: Setup Arduino CLI
      uses: arduino/setup-arduino-cli@v1

    - name: Install ESP32 core
      run: |
        set -e
        URLS="https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json"
        arduino-cli core update-index --additional-urls "$URLS"
        for i in 1 2 3; do
          if arduino-cli core install esp32:esp32 --additional-urls "$URLS"; then
            break
          fi
          echo "Retrying esp32 core install ($i/3)..."
          sleep 10
        done

    - name: Compile all examples (ESP32-S3)
      run: |
        set -e
        for sketch in $(find examples -name "*.ino"); do
          out_dir="build/ci_compile/$(basename "$sketch" .ino)"
          echo "Compiling $sketch"
          arduino-cli compile --fqbn esp32:esp32:esp32s3 "$sketch" --output-dir "$out_dir"
        done
